import { Response } from 'express';
import { AuthRequest } from '../middleware/auth';
import * as authService from '../services/authService';

export const loginController = async (req: AuthRequest, res: Response) => {
  try {
    const { username, password } = req.body;

    if (!username || !password) {
      return res.status(400).json({ error: 'Username and password are required' });
    }

    const result = await authService.login(username, password);
    res.json(result);
  } catch (error: any) {
    console.error('Login error:', error);
    res.status(401).json({ error: error.message || 'Authentication failed' });
  }
};

export const getUsersController = async (req: AuthRequest, res: Response) => {
  try {
    const users = await authService.getAllUsers();
    res.json(users);
  } catch (error) {
    console.error('Get users error:', error);
    res.status(500).json({ error: 'Failed to fetch users' });
  }
};

export const createUserController = async (req: AuthRequest, res: Response) => {
  try {
    const { username, email, password, role } = req.body;
    const createdBy = req.user!.userId;

    if (!username || !password || !role) {
      return res.status(400).json({ error: 'Username, password, and role are required' });
    }

    const user = await authService.createUser(username, email, password, role, createdBy);
    res.status(201).json(user);
  } catch (error: any) {
    console.error('Create user error:', error);
    res.status(500).json({ error: error.message || 'Failed to create user' });
  }
};

export const updateUserController = async (req: AuthRequest, res: Response) => {
  try {
    const { id } = req.params;
    const updates = req.body;
    const updatedBy = req.user!.userId;

    const user = await authService.updateUser(parseInt(id), updates, updatedBy);
    res.json(user);
  } catch (error) {
    console.error('Update user error:', error);
    res.status(500).json({ error: 'Failed to update user' });
  }
};

export const deleteUserController = async (req: AuthRequest, res: Response) => {
  try {
    const { id } = req.params;
    const deletedBy = req.user!.userId;

    await authService.deleteUser(parseInt(id), deletedBy);
    res.json({ message: 'User deleted successfully' });
  } catch (error) {
    console.error('Delete user error:', error);
    res.status(500).json({ error: 'Failed to delete user' });
  }
};

export const resetPasswordController = async (req: AuthRequest, res: Response) => {
  try {
    const { id } = req.params;
    const { newPassword } = req.body;
    const resetBy = req.user!.userId;

    if (!newPassword) {
      return res.status(400).json({ error: 'New password is required' });
    }

    await authService.resetPassword(parseInt(id), newPassword, resetBy);
    res.json({ message: 'Password reset successfully' });
  } catch (error) {
    console.error('Reset password error:', error);
    res.status(500).json({ error: 'Failed to reset password' });
  }
};